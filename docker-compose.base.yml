# docker-compose.base.yml
# (必須の基盤サービス + デフォルトのローカルTempo)

configs:
  otel-collector-config:
    file: ./config/otel-collector/config.yml
  prometheus-config:
    file: ./config/prometheus/prometheus.yml
  fluent-bit-config:
    file: ./config/fluent-bit/fluent-bit.conf
  tempo-local-config:
    file: ./config/tempo/config.local.yml

services:
  # 1. メトリクス (Prometheus)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    volumes:
      - prometheus-data:/prometheus
    configs:
      - source: prometheus-config
        target: /etc/prometheus/prometheus.yml
    ports: ["9090:9090"]
    networks: [observability-net]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. トレース (Grafana Tempo)
  tempo:
    image: grafana/tempo:latest
    container_name: tempo
    command: ["-config.file=/etc/tempo/config.yml"]
    configs:
      - source: tempo-local-config
        target: /etc/tempo/config.yml
    volumes:
      - tempo-data:/var/tempo
    ports: ["3200:3200"]
    networks: [observability-net]
    restart: unless-stopped

  # 3. ログ (OpenSearch)
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: opensearch
    environment: ["discovery.type=single-node", "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g", "DISABLE_SECURITY_PLUGIN=true", "bootstrap.memory_lock=true"]
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile: { soft: 65536, hard: 65536 }
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ports: ["9200:9200"]
    networks: [observability-net]
    healthcheck:
      test: ["CMD-SHELL", "curl -sS -k http://localhost:9200/_cluster/health | grep -qE 'green|yellow'"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # 4. ログ収集 (Fluent Bit)
  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: fluent-bit
    ports: ["24224:24224"]
    configs:
      - source: fluent-bit-config
        target: /fluent-bit/etc/fluent-bit.conf
    networks: [observability-net]
    depends_on:
      opensearch: { condition: service_healthy }
    restart: unless-stopped

  # 5. データハブ (OTel Collector)
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    configs:
      - source: otel-collector-config
        target: /etc/otelcol-contrib/config.yaml
    ports: ["4317:4317", "8889:8889"]
    networks: [observability-net]
    depends_on:
      opensearch: { condition: service_healthy }
      fluent-bit: { condition: service_started }
      # tempo: { condition: service_started }
    restart: unless-stopped

  # 6. 可視化 (Grafana)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports: ["3000:3000"]
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-provisioning:/etc/grafana/provisioning
    environment:
      - "GF_SECURITY_ADMIN_USER=admin"
      - "GF_SECURITY_ADMIN_PASSWORD=admin"
      - "GF_INSTALL_PLUGINS=grafana-opensearch-datasource"
    networks: [observability-net]
    depends_on:
      prometheus: { condition: service_healthy }
      opensearch: { condition: service_healthy }
      tempo: { condition: service_started }
    restart: unless-stopped

# 共通ネットワーク
networks:
  observability-net:
    name: observability-net
    driver: bridge

# Docker に永続化ボリュームの管理を任せる
volumes:
  prometheus-data:
    driver: local
  opensearch-data:
    driver: local
  grafana-data:
    driver: local
  tempo-data:
    driver: local