# docker-compose.langfuse.yml

services:
  # LLMOps (Langfuse)
  langfuse-server:
    image: langfuse/langfuse:latest
    container_name: langfuse-server
    ports: ["3001:3000"] # Grafana(3000)と重複回避
    environment:
      # .env 変数を使って接続文字列を構築
      - DATABASE_URL=postgresql://${LANGFUSE_DB_USER}:${LANGFUSE_DB_PASS}@postgres-metadata:5432/${LANGFUSE_DB_NAME}
      - NEXTAUTH_URL=http://localhost:3001
      - NEXTAUTH_SECRET=${LANGFUSE_NEXTAUTH_SECRET}
      # .env 変数から S3 (rclone) 情報を取得
      - S3_ENDPOINT=http://rclone-s3-gateway:9000
      - S3_BUCKET=langfuse-bucket
      - S3_ACCESS_KEY_ID=${RCLONE_S3_USER}
      - S3_SECRET_ACCESS_KEY=${RCLONE_S3_PASS}
      - S3_REGION=auto
      - S3_FORCE_PATH_STYLE=true
    networks: [observability-net]
    depends_on:
      postgres-metadata: { condition: service_healthy }
      rclone-s3-gateway: { condition: service_started }
    restart: unless-stopped

  # --- 
  # backends.yml の postgres-metadata サービスに設定をマージ
  # ---
  postgres-metadata:
    volumes:
      # Langfuse が必要とするDB初期化スクリプトをマウント
      - ./config/postgres/10-init-langfuse.sh:/docker-entrypoint-initdb.d/10-init-langfuse.sh
    environment:
      # DB初期化スクリプトが必要とする環境変数を渡す
      - LANGFUSE_DB_USER=${LANGFUSE_DB_USER}
      - LANGFUSE_DB_PASS=${LANGFUSE_DB_PASS}
      - LANGFUSE_DB_NAME=${LANGFUSE_DB_NAME}
