# !deprecated
# docker-compose.observability.yml
#
# ===================================================================
#  可観測性スタック (Langfuse 統合版)
# ===================================================================
# 起動コマンド: docker-compose -f docker-compose.observability.yml up -d
#
# 事前準備 (ホストマシン):
# 1. 必要な設定ファイル (.yml, .conf, .json) に加え、
#    ./config/rclone/rclone.conf (Google Drive設定済み) を配置。
#
# 2. setup.sh を実行して、全データディレクトリの権限を設定。

version: '3.8'

configs:
  otel-collector-config:
    file: ./config/otel-collector/config.yml
  prometheus-config:
    file: ./config/prometheus/prometheus.yml
  fluent-bit-config:
    file: ./config/fluent-bit/fluent-bit.conf
  tempo-config:
    file: ./config/tempo/config.yml
  rclone-config:
    file: ./config/rclone/rclone.conf

services:
  # ----------------------------------------
  # 1. メトリクス (Prometheus)
  # ----------------------------------------
  prometheus:
    image: prom/prometheus:v2.47.1
    container_name: prometheus
    volumes:
      - ./data/prometheus:/prometheus
    configs:
      - source: prometheus-config
        target: /etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - observability-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------
  # 2. トレース (Grafana Tempo)
  # ----------------------------------------
  tempo:
    image: grafana/tempo:2.4.1
    container_name: tempo
    command: ["-config.file=/etc/tempo/config.yml"]
    configs:
      - source: tempo-config
        target: /etc/tempo/config.yml
    volumes:
      - ./data/tempo:/var/tempo/wal # WAL (バッファ) 用
    ports:
      - "3200:3200" 
    networks:
      - observability-net
    depends_on:
      - rclone-s3-gateway
    restart: unless-stopped

  # ----------------------------------------
  # 3. ログ (OpenSearch) - インフラログ用
  # ----------------------------------------
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: opensearch
    environment:
      - "discovery.type=single-node"
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "DISABLE_SECURITY_PLUGIN=true"
      - "bootstrap.memory_lock=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ./data/opensearch:/usr/share/opensearch/data
    ports:
      - "9200:9200"
    networks:
      - observability-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sS -k http://localhost:9200/_cluster/health | grep -qE 'green|yellow'"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ----------------------------------------
  # 4. ログ収集 (Fluent Bit) - インフラログ用
  # ----------------------------------------
  fluent-bit:
    image: fluent/fluent-bit:2.1
    container_name: fluent-bit
    ports:
      - "24224:24224"
    configs:
      - source: fluent-bit-config
        target: /fluent-bit/etc/fluent-bit.conf
    networks:
      - observability-net
    depends_on:
      opensearch:
        condition: service_healthy
    restart: unless-stopped

  # ----------------------------------------
  # 5. データハブ (OTel Collector)
  # ----------------------------------------
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.88.0
    container_name: otel-collector
    command: ["--config=/etc/otelcol-contrib/config.yaml"]
    configs:
      - source: otel-collector-config
        target: /etc/otelcol-contrib/config.yaml
    ports:
      - "4317:4317"
      - "8889:8889"
    networks:
      - observability-net
    depends_on:
      - tempo
      - opensearch
      - fluent-bit
    restart: unless-stopped

  # ----------------------------------------
  # 6. 可視化 (Grafana)
  # ----------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./grafana-provisioning:/etc/grafana/provisioning
    environment:
      - "GF_SECURITY_ADMIN_USER=admin"
      - "GF_SECURITY_ADMIN_PASSWORD=admin"
      - "GF_INSTALL_PLUGINS=grafana-opensearch-datasource"
    networks:
      - observability-net
    depends_on:
      prometheus:
        condition: service_healthy
      tempo:
        condition: service_started
      opensearch:
        condition: service_healthy
    restart: unless-stopped

  # ----------------------------------------
  # 7. メタデータDB (PostgreSQL) - (Langfuse/MLflow/Dagster用)
  # ----------------------------------------
  postgres-metadata:  
    image: postgres:15
    container_name: postgres-metadata
    environment:
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD=langfuse
      - POSTGRES_DB=langfuse
    volumes:
      - ./data/postgresql:/var/lib/postgresql/data
    ports:
      - "5432:5432" # ホストからのデバッグ用
    networks:
      - observability-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse -d langfuse"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ----------------------------------------
  # ★ 8. 大容量ストレージ (rclone S3 GW) - (Langfuse/Tempo/MLflow用)
  # ----------------------------------------
  rclone-s3-gateway:
    image: rclone/rclone:latest
    container_name: rclone-s3-gateway
    command: >
      serve s3 gdrive_remote:observability-data # "gdrive_remote"はrclone.conf内のリモート名
      --addr :9000
      --s3-no-vhost
      --s3-auth-user "obs-user"     # 共通アクセスキー
      --s3-auth-pass "obs-password" # 共通シークレットキー
    configs:
      - source: rclone-config
        target: /config/rclone/rclone.conf
    # ports:
    #   - "9000:9000" # デバッグ用
    networks:
      - observability-net
    restart: unless-stopped

  # ----------------------------------------
  # ★ 9. LLMOps (Langfuse) - GenAIログ用
  # ----------------------------------------
  langfuse-server:
    image: langfuse/langfuse:latest
    container_name: langfuse-server
    ports:
      - "3001:3000" # Grafana(3000)と重複するため 3001 に変更
    environment:
      - DATABASE_URL=postgresql://langfuse:langfuse@postgres-metadata:5432/langfuse
      - NEXTAUTH_URL=http://localhost:3001
      - NEXTAUTH_SECRET=mysecretkey # 本番環境では要変更
      # S3 (rclone GDrive) 設定
      - S3_ENDPOINT=http://rclone-s3-gateway:9000
      - S3_BUCKET=langfuse-bucket
      - S3_ACCESS_KEY_ID=obs-user
      - S3_SECRET_ACCESS_KEY=obs-password
      - S3_REGION=auto
      - S3_FORCE_PATH_STYLE=true
    networks:
      - observability-net
    depends_on:
      postgres-metadata:
        condition: service_healthy
      rclone-s3-gateway:
        condition: service_started
    restart: unless-stopped


# 共通ネットワーク
networks:
  observability-net:
    name: observability-net
    driver: bridge